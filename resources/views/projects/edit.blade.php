@extends('layouts.app')

@section('title', 'ุชุนุฏูู ุงููุดุฑูุน')

@push('styles')
<link rel="stylesheet" href="{{ asset('css/projects.css') }}">
<link rel="stylesheet" href="{{ asset('css/projects/project-create-modern.css') }}">
@endpush

@section('content')
@php
    $createdDate = $project->created_at instanceof \Carbon\Carbon ? $project->created_at : \Carbon\Carbon::parse($project->created_at);
    $now = \Carbon\Carbon::now();
    $daysAgo = (int)$createdDate->diffInDays($now);
    $isOldProject = $daysAgo >= 2;


    Log::info("Project Age Debug", [
        'created_at' => $createdDate->format('Y-m-d H:i:s'),
        'days_ago' => $daysAgo,
        'is_old_project' => $isOldProject
    ]);
@endphp

<div class="create-modern-container">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-11">
            <div class="create-glass-card">
                <div class="create-modern-header">
                    <div class="create-header-icon">
                        <i class="fas fa-edit"></i>
                    </div>
                    <h3 class="create-header-title">
                        ุชุนุฏูู ุงููุดุฑูุน: {{ $project->name }}
                    </h3>
                    <p class="text-white-50 mb-0 mt-2">ุญุฏูุซ ุจูุงูุงุช ูุดุฑูุนู ุจุณูููุฉ ูุงุญุชุฑุงููุฉ</p>
                </div>
                <div class="create-form-body">
                    <form action="{{ route('projects.update', $project) }}" method="POST">
                        @csrf
                        @method('PUT')

                        <div class="row">
                            <!-- ูุนูููุงุช ุงููุดุฑูุน ุงูุฃุณุงุณูุฉ -->
                            <div class="col-md-6">
                                <div class="create-section-header info">
                                    <i class="fas fa-info-circle"></i>
                                    <h5>ูุนูููุงุช ุงููุดุฑูุน ุงูุฃุณุงุณูุฉ</h5>
                                </div>

                                <div class="create-form-group">
                                    <label for="name" class="create-form-label">
                                        <i class="fas fa-project-diagram"></i>
                                        ุงุณู ุงููุดุฑูุน *
                                    </label>
                                    <input type="text"
                                           class="create-form-control @error('name') is-invalid @enderror"
                                           id="name"
                                           name="name"
                                           value="{{ old('name', $project->name) }}"
                                           placeholder="ุงูุชุจ ุงุณู ูุดุฑูุนู ููุง..."
                                           required
                                           {{ $isOldProject ? 'disabled' : '' }}>
                                    @error('name')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                    @if($isOldProject)
                                        <small class="form-text text-muted"><i class="fas fa-lock me-1"></i>ููููู</small>
                                    @endif
                                </div>

                                <div class="create-form-group">
                                    <label for="code" class="create-form-label">
                                        <i class="fas fa-qrcode"></i>
                                        ููุฏ ุงููุดุฑูุน
                                    </label>
                                    <div class="create-input-group" style="position: relative;">
                                        <!-- Hidden input ููุฅุฑุณุงู ูุน ุงูููุฑู -->
                                        <input type="hidden" name="code" value="{{ $project->code }}">
                                        <!-- ุญูู ุงููุฑุงุกุฉ ููุท ููุนุฑุถ -->
                                        <input type="text"
                                               class="create-form-control"
                                               id="code_display"
                                               value=""
                                               readonly
                                               style="background-color: #f8f9fa !important; color: #212529 !important; cursor: not-allowed; padding-right: 120px; padding-left: 80px; font-weight: 600; border: 1px solid #dee2e6; font-size: 14px;"
                                               title="ููุฏ ุงููุดุฑูุน ูุง ูููู ุชุนุฏููู"
                                               onfocus="this.blur()"
                                               onkeydown="return false">
                                        <!-- ุนุฑุถ ููุฏ ุงููุดุฑูุน ุนูู ุงูุดูุงู -->
                                        <div class="project-code-display" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                                            <i class="fas fa-hashtag"></i> {{ $project->code }}
                                        </div>
                                        <!-- ุบูุฑ ูุงุจู ููุชุนุฏูู ุนูู ุงููููู -->
                                        <div class="create-readonly-label" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">
                                            <i class="fas fa-lock"></i> ุบูุฑ ูุงุจู ููุชุนุฏูู
                                        </div>
                                        @error('code')
                                            <div class="invalid-feedback">{{ $message }}</div>
                                        @enderror
                                    </div>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        ููุฏ ุงููุดุฑูุน ุซุงุจุช ููุง ูููู ุชุนุฏููู ุจุนุฏ ุฅูุดุงุก ุงููุดุฑูุน
                                    </small>
                                </div>

                                <div class="create-form-group">
                                    <label for="company_type" class="create-form-label">
                                        <i class="fas fa-building"></i>
                                        ููุน ุงูุดุฑูุฉ
                                    </label>
                                    <select class="create-form-control @error('company_type') is-invalid @enderror"
                                            id="company_type"
                                            name="company_type"
                                            {{ $isOldProject ? 'disabled' : '' }}>
                                        <option value="">๐ข ุงุฎุชุฑ ููุน ุงูุดุฑูุฉ</option>
                                        <option value="A" {{ old('company_type', $project->company_type) == 'A' ? 'selected' : '' }}>A - ุฃุฑูุงู</option>
                                        <option value="K" {{ old('company_type', $project->company_type) == 'K' ? 'selected' : '' }}>K - ุฎุจุฑุงุก</option>
                                    </select>
                                    @error('company_type')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                    @if($isOldProject)
                                        <small class="form-text text-muted"><i class="fas fa-lock me-1"></i>ููููู</small>
                                    @endif
                                </div>

                                <div class="create-form-group">
                                    <label for="description" class="create-form-label">
                                        <i class="fas fa-align-left"></i>
                                        ูุตู ุงููุดุฑูุน
                                    </label>
                                    <textarea class="create-form-control @error('description') is-invalid @enderror"
                                              id="description"
                                              name="description"
                                              rows="4"
                                              placeholder="ุงูุชุจ ูุตูุงู ููุตูุงู ุนู ูุดุฑูุนู ูุฃูุฏุงูู..."
                                              {{ $isOldProject ? 'disabled' : '' }}>{{ old('description', $project->description) }}</textarea>
                                    @error('description')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                    @if($isOldProject)
                                        <small class="form-text text-muted"><i class="fas fa-lock me-1"></i>ููููู</small>
                                    @endif
                                </div>

                                <div class="create-form-group">
                                    <label for="client_id" class="create-form-label">
                                        <i class="fas fa-user-tie"></i>
                                        ุงูุนููู *
                                    </label>
                                    <select class="create-form-control @error('client_id') is-invalid @enderror"
                                            id="client_id"
                                            name="client_id"
                                            required
                                            {{ $isOldProject ? 'disabled' : '' }}>
                                        <option value="">๐ข ุงุฎุชุฑ ุงูุนููู ุงูููุงุณุจ</option>
                                        @foreach($clients as $client)
                                            <option value="{{ $client->id }}"
                                                    {{ old('client_id', $project->client_id) == $client->id ? 'selected' : '' }}>
                                                {{ $client->name }} - {{ $client->code }}
                                            </option>
                                        @endforeach
                                    </select>
                                    @error('client_id')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                    @if($isOldProject)
                                        <small class="form-text text-muted"><i class="fas fa-lock me-1"></i>ููููู</small>
                                    @endif
                                </div>

                                <div class="create-form-group">
                                    <label for="manager" class="create-form-label">
                                        <i class="fas fa-user-cog"></i>
                                        ูุฏูุฑ ุงููุดุฑูุน
                                    </label>
                                    <input type="text" class="create-form-control @error('manager') is-invalid @enderror"
                                           id="manager" name="manager" value="{{ old('manager', $project->manager) }}"
                                           placeholder="ุงุณู ูุฏูุฑ ุงููุดุฑูุน..."
                                           disabled
                                           style="background-color: #f8f9fa; cursor: not-allowed;">
                                    @error('manager')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                    <small class="form-text text-muted"><i class="fas fa-lock me-1"></i><strong>ูุฐุง ุงูุญูู ูุง ูููู ุชุนุฏููู ููุงุฆูุงู - ุชู ุชุนูููู ุนูุฏ ุฅูุดุงุก ุงููุดุฑูุน</strong></small>
                                </div>
                                <div class="create-form-group">
                                    <label for="note" class="create-form-label">
                                        <i class="fas fa-sticky-note"></i>
                                        ููุงุญุธุงุช ูุงูุฉ
                                    </label>
                                    <textarea class="create-form-control @error('note') is-invalid @enderror"
                                              id="note" name="note" rows="3"
                                              placeholder="ุงูุชุจ ุฃู ููุงุญุธุงุช ูุงูุฉ ุญูู ุงููุดุฑูุน..."
                                              {{ $isOldProject ? 'disabled' : '' }}>{{ old('note', $project->note) }}</textarea>
                                    @error('note')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                    @if($isOldProject)
                                        <small class="form-text text-muted"><i class="fas fa-lock me-1"></i>ููููู</small>
                                    @endif
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="create-form-group">
                                            <label for="team_delivery_date" class="create-form-label">
                                                <i class="fas fa-users-cog"></i>
                                                ุชุงุฑูุฎ ุชุณููู ุงููุฑูู
                                                <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="showDateHistory('team_delivery_date')" title="ุนุฑุถ ุชุงุฑูุฎ ุงูุชุนุฏููุงุช">
                                                    <i class="fas fa-history"></i>
                                                </button>
                                            </label>
                                            <input type="date" class="create-form-control @error('team_delivery_date') is-invalid @enderror"
                                                   id="team_delivery_date" name="team_delivery_date"
                                                   value="{{ old('team_delivery_date', $project->team_delivery_date?->format('Y-m-d')) }}">
                                            @error('team_delivery_date')
                                                <div class="invalid-feedback">{{ $message }}</div>
                                            @enderror
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="create-form-group">
                                            <label for="start_date" class="create-form-label">
                                                <i class="fas fa-calendar-plus"></i>
                                                ุชุงุฑูุฎ ุงูุจุฏุงูุฉ
                                            </label>
                                            <input type="date"
                                                   class="create-form-control @error('start_date') is-invalid @enderror"
                                                   id="start_date"
                                                   name="start_date"
                                                   value="{{ old('start_date', $project->start_date?->format('Y-m-d')) }}">
                                            @error('start_date')
                                                <div class="invalid-feedback">{{ $message }}</div>
                                            @enderror
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="create-form-group">
                                            <label for="client_agreed_delivery_date" class="create-form-label">
                                                <i class="fas fa-handshake"></i>
                                                ุชุงุฑูุฎ ุงูุชุณููู ุงููุชูู ุนููู
                                            </label>
                                            <input type="date"
                                                   class="create-form-control @error('client_agreed_delivery_date') is-invalid @enderror"
                                                   id="client_agreed_delivery_date"
                                                   name="client_agreed_delivery_date"
                                                   value="{{ old('client_agreed_delivery_date', $project->client_agreed_delivery_date?->format('Y-m-d')) }}">
                                            @error('client_agreed_delivery_date')
                                                <div class="invalid-feedback">{{ $message }}</div>
                                            @enderror
                                        </div>
                                    </div>
                                </div>

                                <div class="create-form-group">
                                    <label for="status" class="create-form-label">
                                        <i class="fas fa-chart-line"></i>
                                        ุญุงูุฉ ุงููุดุฑูุน *
                                    </label>
                                    <select class="create-form-control @error('status') is-invalid @enderror"
                                            id="status"
                                            name="status"
                                            required
                                            {{ $isOldProject ? 'disabled' : '' }}>
                                        <option value="ุฌุฏูุฏ" {{ old('status', $project->status) == 'ุฌุฏูุฏ' ? 'selected' : '' }}>๐ ุฌุฏูุฏ</option>
                                        <option value="ุฌุงุฑู ุงูุชูููุฐ" {{ old('status', $project->status) == 'ุฌุงุฑู ุงูุชูููุฐ' ? 'selected' : '' }}>โ๏ธ ุฌุงุฑู ุงูุชูููุฐ</option>
                                        <option value="ููุชูู" {{ old('status', $project->status) == 'ููุชูู' ? 'selected' : '' }}>โ ููุชูู</option>
                                        <option value="ููุบู" {{ old('status', $project->status) == 'ููุบู' ? 'selected' : '' }}>โ ููุบู</option>
                                    </select>
                                    @error('status')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                    @if($isOldProject)
                                        <small class="form-text text-muted"><i class="fas fa-lock me-1"></i>ููููู</small>
                                    @endif
                                </div>

                                <div class="create-form-group">
                                    <div class="create-alert urgent-alert">
                                        <div class="urgent-switch-wrapper">
                                            <input class="urgent-checkbox @error('is_urgent') is-invalid @enderror"
                                                   type="checkbox"
                                                   id="is_urgent"
                                                   name="is_urgent"
                                                   value="1"
                                                   {{ old('is_urgent', $project->is_urgent) ? 'checked' : '' }}
                                                   {{ $isOldProject ? 'disabled' : '' }}>
                                            <div>
                                                <label class="urgent-label" for="is_urgent">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                                    ูุดุฑูุน ูุณุชุนุฌู ูุนุงุฌู
                                                </label>
                                                <p class="urgent-description">
                                                    ุณูุชู ุฅุนุทุงุก ูุฐุง ุงููุดุฑูุน ุงูุฃููููุฉ ุงูุนุงููุฉ ูู ุงูุนุฑุถ ูุงูุฅุดุนุงุฑุงุช
                                                </p>
                                            </div>
                                        </div>
                                        @error('is_urgent')
                                            <div class="invalid-feedback">{{ $message }}</div>
                                        @enderror
                                    </div>
                                </div>

                                <!-- ูุชุฑุฉ ุงูุชุญุถูุฑ -->
                                <div class="create-form-group">
                                    <div class="create-alert" style="background: rgba(103, 126, 234, 0.1); border-color: rgba(103, 126, 234, 0.3);">
                                        <div class="urgent-switch-wrapper mb-3">
                                            <input class="urgent-checkbox @error('preparation_enabled') is-invalid @enderror"
                                                   type="checkbox"
                                                   id="preparation_enabled"
                                                   name="preparation_enabled"
                                                   value="1"
                                                   style="accent-color: #667eea;"
                                                   {{ old('preparation_enabled', $project->preparation_enabled) ? 'checked' : '' }}>
                                            <div>
                                                <label class="urgent-label" for="preparation_enabled" style="color: #667eea;">
                                                    <i class="fas fa-clock me-2"></i>
                                                    ุชูุนูู ูุชุฑุฉ ุงูุชุญุถูุฑ
                                                </label>
                                                <p class="urgent-description">
                                                    ุชุญุฏูุฏ ูุชุฑุฉ ุชุญุถูุฑ ูุจู ุจุฏุก ุงูุนูู ุงููุนูู ุนูู ุงููุดุฑูุน (ุงุณุชุซูุงุก ููู ุงูุฌูุนุฉ)
                                                </p>
                                            </div>
                                        </div>
                                        @error('preparation_enabled')
                                            <div class="invalid-feedback">{{ $message }}</div>
                                        @enderror

                                        <div id="preparation-fields" style="display: {{ old('preparation_enabled', $project->preparation_enabled) ? 'block' : 'none' }}; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(103, 126, 234, 0.2);">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="preparation_start_date" class="create-form-label" style="font-size: 0.85rem;">
                                                        <i class="fas fa-calendar-day me-1"></i>
                                                        ุชุงุฑูุฎ ูููุช ุจุฏุงูุฉ ุงูุชุญุถูุฑ
                                                    </label>
                                                    <input type="datetime-local"
                                                           class="create-form-control @error('preparation_start_date') is-invalid @enderror"
                                                           id="preparation_start_date"
                                                           name="preparation_start_date"
                                                           value="{{ old('preparation_start_date', $project->preparation_start_date?->format('Y-m-d\TH:i')) }}"
                                                           style="font-size: 0.85rem;">
                                                    @error('preparation_start_date')
                                                        <div class="invalid-feedback">{{ $message }}</div>
                                                    @enderror
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="preparation_days" class="create-form-label" style="font-size: 0.85rem;">
                                                        <i class="fas fa-calendar-check me-1"></i>
                                                        ุนุฏุฏ ุฃูุงู ุงูุชุญุถูุฑ
                                                    </label>
                                                    <input type="number"
                                                           class="create-form-control @error('preparation_days') is-invalid @enderror"
                                                           id="preparation_days"
                                                           name="preparation_days"
                                                           value="{{ old('preparation_days', $project->preparation_days) }}"
                                                           min="1"
                                                           placeholder="ูุซุงู: 5"
                                                           style="font-size: 0.85rem;">
                                                    @error('preparation_days')
                                                        <div class="invalid-feedback">{{ $message }}</div>
                                                    @enderror
                                                    <small class="form-text text-muted" style="font-size: 0.75rem;">
                                                        <i class="fas fa-info-circle me-1"></i>
                                                        ุณูุชู ุญุณุงุจ ุชุงุฑูุฎ ุงูููุงูุฉ ุชููุงุฆูุงู (ุจุฏูู ููู ุงูุฌูุนุฉ)
                                                    </small>
                                                </div>
                                            </div>
                                            @if($project->preparation_enabled && $project->preparation_start_date && $project->preparation_days)
                                                <div class="alert alert-info" style="font-size: 0.8rem;">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    <strong>ุชุงุฑูุฎ ูููุช ุงูููุงูุฉ ุงููุญุณูุจ:</strong> {{ $project->preparation_end_date?->format('Y-m-d H:i') ?? 'ุบูุฑ ูุญุฏุฏ' }}
                                                    @if($project->isInPreparationPeriod())
                                                        <br><span class="badge bg-primary mt-1">ุงููุดุฑูุน ูู ูุชุฑุฉ ุงูุชุญุถูุฑ ุญุงููุงู - ุจุงูู {{ $project->remaining_preparation_days }} ููู</span>
                                                    @elseif($project->hasPreparationPeriodEnded())
                                                        <br><span class="badge bg-success mt-1">ุงูุชูุช ูุชุฑุฉ ุงูุชุญุถูุฑ</span>
                                                    @else
                                                        <br><span class="badge bg-warning mt-1">ูู ุชุจุฏุฃ ูุชุฑุฉ ุงูุชุญุถูุฑ ุจุนุฏ</span>
                                                    @endif
                                                </div>
                                            @endif
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ุงูุฎุฏูุงุช ุงููุฎุชุงุฑุฉ -->
                            <div class="col-md-6">
                                <div class="create-section-header success">
                                    <i class="fas fa-cogs"></i>
                                    <h5>ุงูุฎุฏูุงุช ูุงูุจุงูุงุช ุงููุทููุจุฉ</h5>
                                </div>
                                <div class="create-form-group">
                                    <label class="create-form-label">
                                        <i class="fas fa-layer-group"></i>
                                        ููุน ุงูุงุฎุชูุงุฑ:
                                    </label>
                                    <div class="create-selection-type">
                                        <div class="create-radio-option">
                                            <input type="radio" name="selection_type" id="select_package" value="package" {{ $project->package_id ? 'checked' : '' }}>
                                            <label for="select_package">๐ ุงุฎุชูุงุฑ ุจุงูุฉ</label>
                                        </div>
                                        <div class="create-radio-option">
                                            <input type="radio" name="selection_type" id="select_services" value="services" {{ $project->package_id ? '' : 'checked' }}>
                                            <label for="select_services">โ๏ธ ุงุฎุชูุงุฑ ุฎุฏูุงุช ูููุตูุฉ</label>
                                        </div>
                                    </div>
                                </div>
                                <div id="package-section" class="create-package-section {{ $project->package_id ? 'show' : 'hide' }}">
                                    <div class="create-form-group">
                                        <label class="create-form-label">
                                            <i class="fas fa-gift"></i>
                                            ุงุฎุชุฑ ุงูุจุงูุฉ
                                        </label>
                                        <select name="package_id" id="package_id" class="create-form-control" {{ $isOldProject ? 'disabled' : '' }}>
                                            <option value="">๐ ุงุฎุชุฑ ุจุงูุฉ ููุงุณุจุฉ</option>
                                            @foreach($packages as $package)
                                                <option value="{{ $package['id'] }}" data-services="{{ json_encode($package['services']) }}" {{ $project->package_id == $package['id'] ? 'selected' : '' }}>{{ $package['name'] }} ({{ $package['total_points'] }} ููุทุฉ)</option>
                                            @endforeach
                                        </select>
                                    </div>

                                    <!-- ุนุฑุถ ุฎุฏูุงุช ุงูุจุงูุฉ ุจุนุฏ ุงูุงุฎุชูุงุฑ -->
                                    <div id="package-services-section" style="display: {{ $project->package_id ? 'block' : 'none' }};">
                                        <div class="create-alert info" style="margin-top: 1.5rem;">
                                            <i class="fas fa-box-open"></i>
                                            <span><strong>ุฎุฏูุงุช ุงูุจุงูุฉ ุงููุฎุชุงุฑุฉ</strong> - ููููู ุฅูุบุงุก ุฃู ุฎุฏูุฉ ูุง ุชุฑูุฏูุง</span>
                                        </div>
                                        <div class="create-services-container" id="package-services-list">
                                            <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู ุนุจุฑ JavaScript -->
                                        </div>

                                        <!-- ุงูุฎุฏูุงุช ุงูุฅุถุงููุฉ (ุฎุงุฑุฌ ุงูุจุงูุฉ) -->
                                        <div class="create-alert" style="margin-top: 1.5rem; background: rgba(103, 126, 234, 0.1); border-color: rgba(103, 126, 234, 0.3);">
                                            <i class="fas fa-plus-circle"></i>
                                            <span><strong>ุฎุฏูุงุช ุฅุถุงููุฉ</strong> - ููููู ุฅุถุงูุฉ ุฎุฏูุงุช ุฃุฎุฑู ุบูุฑ ููุฌูุฏุฉ ูู ุงูุจุงูุฉ</span>
                                        </div>
                                        <div class="create-services-container" id="additional-services-list">
                                            <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู ุนุจุฑ JavaScript -->
                                        </div>
                                    </div>
                                </div>
                                <div id="services-section" class="create-services-section {{ $project->package_id ? 'hide' : 'show' }}">
                                    <div class="create-alert info">
                                        <i class="fas fa-lightbulb"></i>
                                        <span>ุงุฎุชุฑ ุงูุฎุฏูุงุช ุงูุชู ูุญุชุงุฌูุง ุงูุนููู ูุญุฏุฏ ุญุงูุฉ ูู ุฎุฏูุฉ</span>
                                    </div>
                                    <div class="create-services-container">
                                        @foreach($services as $service)
                                            @php
                                                $isSelected = $project->services->contains($service->id);
                                                $serviceStatus = $isSelected ? $project->services->find($service->id)->pivot->service_status : 'ูู ุชุจุฏุฃ';
                                            @endphp
                                            <div class="create-service-card {{ $isSelected ? 'selected' : '' }}">
                                                <div class="create-service-content">
                                                    <div class="create-service-header">
                                                        <input class="create-service-checkbox" type="checkbox" value="{{ $service->id }}" id="service_{{ $service->id }}" name="selected_services[]" {{ $isSelected ? 'checked' : '' }} {{ $isOldProject ? 'disabled' : '' }}>
                                                        <div>
                                                            <h6 class="create-service-title">{{ $service->name }}</h6>
                                                            <p class="create-service-description">{{ $service->description }}</p>
                                                            <span class="create-service-points">
                                                                <i class="fas fa-star me-1"></i>
                                                                {{ $service->points }} ููุทุฉ
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div class="create-service-status {{ $isSelected ? 'show' : '' }}">
                                                        <label class="create-form-label">
                                                            <i class="fas fa-tasks"></i>
                                                            ุญุงูุฉ ุงูุฎุฏูุฉ:
                                                        </label>
                                                        <select class="create-form-control" name="service_statuses[{{ $service->id }}]">
                                                            <option value="ูู ุชุจุฏุฃ" {{ $serviceStatus == 'ูู ุชุจุฏุฃ' ? 'selected' : '' }}>๐ ูู ุชุจุฏุฃ</option>
                                                            <option value="ููุฏ ุงูุชูููุฐ" {{ $serviceStatus == 'ููุฏ ุงูุชูููุฐ' ? 'selected' : '' }}>โ๏ธ ููุฏ ุงูุชูููุฐ</option>
                                                            <option value="ููุชููุฉ" {{ $serviceStatus == 'ููุชููุฉ' ? 'selected' : '' }}>โ ููุชููุฉ</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        @endforeach
                                    </div>
                                </div>
                                <div class="create-total-points">
                                    <h6>ูุฌููุน ุงูููุงุท ุงููุฎุชุงุฑุฉ:</h6>
                                    <div class="points-number">
                                        <span id="total-points">{{ $project->total_points }}</span> ููุทุฉ
                                    </div>
                                    <i class="fas fa-star" style="position: absolute; top: 10px; right: 15px; font-size: 1.5rem; opacity: 0.3; z-index: 1;"></i>
                                </div>
                            </div>
                        </div>

                        <div class="create-actions">
                            <a href="{{ route('projects.index') }}" class="create-btn create-btn-secondary">
                                <i class="fas fa-arrow-right"></i>
                                ุนูุฏุฉ ูููุงุฆูุฉ
                            </a>
                            <button type="submit" class="create-btn create-btn-success">
                                <i class="fas fa-sync-alt"></i>
                                ุชุญุฏูุซ ุงููุดุฑูุน
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
@endsection

@push('scripts')
<script>
// ุชูุฑูุฑ ุจูุงูุงุช ุงูุฎุฏูุงุช ูุงููุดุฑูุน ูู JavaScript
const allServices = @json($services);
const currentProject = @json($project);
const isOldProject = @json($isOldProject);

// ููุฏ ุงููุดุฑูุน ุบูุฑ ูุงุจู ููุชุนุฏูู ูู ุตูุญุฉ ุงูุชุนุฏูู

function switchSection(showPackage) {
    const packageSection = document.getElementById('package-section');
    const servicesSection = document.getElementById('services-section');

    if (showPackage) {
        packageSection.classList.remove('hide');
        packageSection.classList.add('show');
        servicesSection.classList.remove('show');
        servicesSection.classList.add('hide');
    } else {
        packageSection.classList.remove('show');
        packageSection.classList.add('hide');
        servicesSection.classList.remove('hide');
        servicesSection.classList.add('show');
    }
    updateTotalPoints();
}

document.getElementById('select_package').addEventListener('change', function() {
    if (this.checked) {
        switchSection(true);
    }
});

document.getElementById('select_services').addEventListener('change', function() {
    if (this.checked) {
        switchSection(false);
    }
});

document.querySelectorAll('.create-service-checkbox').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
        const serviceCard = this.closest('.create-service-card');
        const statusContainer = serviceCard.querySelector('.create-service-status');

        if (this.checked) {
            serviceCard.classList.add('selected');
            statusContainer.classList.add('show');
        } else {
            serviceCard.classList.remove('selected');
            statusContainer.classList.remove('show');
        }
        updateTotalPoints();
    });
});

function updateTotalPoints() {
    let totalPoints = 0;

    if (document.getElementById('select_package').checked) {
        // ุญุณุงุจ ุงูููุงุท ูู ุฎุฏูุงุช ุงูุจุงูุฉ ุงููุญุฏุฏุฉ + ุงูุฎุฏูุงุช ุงูุฅุถุงููุฉ ุงููุญุฏุฏุฉ
        document.querySelectorAll('#package-services-list .create-service-checkbox:checked, #additional-services-list .create-service-checkbox:checked').forEach(function(checkbox) {
            const pointsText = checkbox.closest('.create-service-card').querySelector('.create-service-points').textContent.trim();
            const points = parseInt(pointsText);
            if (!isNaN(points)) {
                totalPoints += points;
            }
        });
    } else {
        // ุญุณุงุจ ุงูููุงุท ูู ุงูุฎุฏูุงุช ุงููุฎุชุงุฑุฉ ูุฏููุงู
        document.querySelectorAll('#services-section .create-service-checkbox:checked').forEach(function(checkbox) {
            const pointsText = checkbox.closest('.create-service-card').querySelector('.create-service-points').textContent.trim();
            const points = parseInt(pointsText);
            if (!isNaN(points)) {
                totalPoints += points;
            }
        });
    }

    const pointsElement = document.getElementById('total-points');
    pointsElement.textContent = totalPoints;
}

// ุชุญุฏูุซ ุงูููุงุท ุนูุฏ ุชุบููุฑ ุงูุจุงูุฉ
document.getElementById('package_id').addEventListener('change', function() {
    handlePackageChange();
    updateTotalPoints();
});

// ูุนุงูุฌุฉ ุชุบููุฑ ุงูุจุงูุฉ - ุนุฑุถ ุฎุฏูุงุชูุง
function handlePackageChange() {
    const packageSelect = document.getElementById('package_id');
    const packageServicesSection = document.getElementById('package-services-section');
    const packageServicesList = document.getElementById('package-services-list');
    const additionalServicesList = document.getElementById('additional-services-list');

    if (packageSelect.value) {
        // ุงูุญุตูู ุนูู ุฎุฏูุงุช ุงูุจุงูุฉ ุงููุฎุชุงุฑุฉ
        const selectedOption = packageSelect.options[packageSelect.selectedIndex];
        const packageServices = JSON.parse(selectedOption.getAttribute('data-services') || '[]');

        // ูุณุญ ุงูููุงุฆู ุงูุณุงุจูุฉ
        packageServicesList.innerHTML = '';
        additionalServicesList.innerHTML = '';

        // ุนุฑุถ ุฎุฏูุงุช ุงูุจุงูุฉ (ูุญุฏุฏุฉ ุจุนูุงูุฉ โ)
        packageServices.forEach(serviceId => {
            const service = allServices.find(s => s.id == serviceId);
            if (service) {
                // ุงูุชุญูู ุฅุฐุง ูุงูุช ุงูุฎุฏูุฉ ูุญุฏุฏุฉ ูู ุงููุดุฑูุน ุงูุญุงูู
                const isChecked = currentProject.services.some(s => s.id == serviceId);
                const serviceCard = createServiceCard(service, isChecked, true); // true ููุจุงูุฉ
                packageServicesList.appendChild(serviceCard);
            }
        });

        // ุนุฑุถ ุงูุฎุฏูุงุช ุงูุฅุถุงููุฉ (ุบูุฑ ูุญุฏุฏุฉุ ุฎุงุฑุฌ ุงูุจุงูุฉ)
        allServices.forEach(service => {
            // ุฅุฐุง ูู ุชูู ุงูุฎุฏูุฉ ุถูู ุฎุฏูุงุช ุงูุจุงูุฉ
            if (!packageServices.includes(service.id)) {
                // ุงูุชุญูู ุฅุฐุง ูุงูุช ุงูุฎุฏูุฉ ูุญุฏุฏุฉ ูู ุงููุดุฑูุน ุงูุญุงูู (ุฑุจูุง ุฃุถุงููุง ุงููุณุชุฎุฏู ุณุงุจูุงู)
                const isChecked = currentProject.services.some(s => s.id == service.id);
                const serviceCard = createServiceCard(service, isChecked, false); // false ููุจุงูุฉ
                additionalServicesList.appendChild(serviceCard);
            }
        });

        packageServicesSection.style.display = 'block';
    } else {
        packageServicesSection.style.display = 'none';
        packageServicesList.innerHTML = '';
        additionalServicesList.innerHTML = '';
    }
}

// ุฅูุดุงุก ุจุทุงูุฉ ุฎุฏูุฉ ุฏููุงููููุงู
function createServiceCard(service, isChecked = false, isFromPackage = false) {
    const card = document.createElement('div');
    card.className = 'create-service-card' + (isChecked ? ' selected' : '');

    const badgeHtml = isFromPackage ? '<span class="badge bg-primary me-2" style="font-size: 0.7rem;"><i class="fas fa-box-open me-1"></i>ูู ุงูุจุงูุฉ</span>' : '';

    card.innerHTML = `
        <div class="create-service-content">
            <div class="create-service-header">
                <input class="create-service-checkbox" type="checkbox" value="${service.id}"
                       id="service_${service.id}" name="selected_services[]" ${isChecked ? 'checked' : ''}
                       ${isOldProject ? 'disabled' : ''}>
                <div>
                    ${badgeHtml}
                    <h6 class="create-service-title">${service.name}</h6>
                    <p class="create-service-description">${service.description || ''}</p>
                    <span class="create-service-points">
                        <i class="fas fa-star me-1"></i>
                        ${service.points} ููุทุฉ
                    </span>
                </div>
            </div>
        </div>
    `;

    // ุฅุถุงูุฉ event listener ููู checkbox (ููุท ุฅุฐุง ูู ููู ุงููุดุฑูุน ูุฏูู)
    if (!isOldProject) {
        const checkbox = card.querySelector('.create-service-checkbox');
        checkbox.addEventListener('change', function() {
            const serviceCard = this.closest('.create-service-card');

            if (this.checked) {
                serviceCard.classList.add('selected');
            } else {
                serviceCard.classList.remove('selected');
            }
            updateTotalPoints();
        });
    }

    return card;
}

// ุชุญููู ุฎุฏูุงุช ุงูุจุงูุฉ ุนูุฏ ุชุญููู ุงูุตูุญุฉ ุฅุฐุง ูุงูุช ุจุงูุฉ ูุญุฏุฏุฉ
if (currentProject.package_id) {
    handlePackageChange();
}

updateTotalPoints();
console.log('๐ ูุฑุญุจุงู ุจู ูู ุตูุญุฉ ุชุนุฏูู ุงููุดุฑูุน! ุญุฏูุซ ุจูุงูุงุชู ุจุณูููุฉ โจ');

const preparationCheckbox = document.getElementById('preparation_enabled');
const preparationFields = document.getElementById('preparation-fields');
const preparationStartDate = document.getElementById('preparation_start_date');

if (preparationCheckbox && preparationFields) {
    preparationCheckbox.addEventListener('change', function() {
        if (this.checked) {
            preparationFields.style.display = 'block';

            if (!preparationStartDate.value) {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');

                preparationStartDate.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
        } else {
            preparationFields.style.display = 'none';
            document.getElementById('preparation_start_date').value = '';
            document.getElementById('preparation_days').value = '';
        }
    });
}
</script>
@endpush
